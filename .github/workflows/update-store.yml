name: Sync and PR to SineOrg Store

on:
  push:
    branches:
      - main
    paths:
      - 'JS/Nebula.uc.js'

jobs:
  update-store:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Zen-Nebula
        uses: actions/checkout@v3

      - name: Checkout fork (JustAdumbPrsn/store)
        uses: actions/checkout@v3
        with:
          repository: JustAdumbPrsn/store
          token: ${{ secrets.FORK_PAT }}
          path: store-fork

      - name: Sync fork with upstream
        run: |
          cd store-fork
          git remote add upstream https://github.com/sineorg/store.git
          git fetch upstream
          git checkout main
          git reset --hard upstream/main
          git push origin main --force

      - name: Create update branch
        run: |
          cd store-fork
          git checkout -B auto-update-nebula

      - name: Copy updated Nebula.uc.js from Zen-Nebula
        run: |
          cp JS/Nebula.uc.js store-fork/mods/Nebula/Nebula.uc.js

      - name: Commit updated Nebula.uc.js
        run: |
          cd store-fork
          git add mods/Nebula/Nebula.uc.js
          git commit -m "Update Nebula.uc.js from Zen-Nebula main branch" || echo "No changes"
          git push origin auto-update-nebula --force

      - name: Setup GitHub CLI
        uses: cli/cli-action@v2

      - name: Create Pull Request to sineorg/store
        env:
          GH_TOKEN: ${{ secrets.FORK_PAT }}
        run: |
          gh pr create \
            --repo sineorg/store \
            --head JustAdumbPrsn:auto-update-nebula \
            --base main \
            --title "Automated update of Nebula.uc.js" \
            --body "This PR was automatically created by GitHub Actions to sync Nebula.uc.js from Zen-Nebula."
